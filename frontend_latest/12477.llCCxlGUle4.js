export const id=12477;export const ids=[12477];export const modules={10469:(e,t,s)=>{s.d(t,{$:()=>a});s(89655);const a=(e,t)=>{const s={};for(const a of e){const e=t(a);e in s?s[e].push(a):s[e]=[a]}return s}},47076:(e,t,s)=>{s.a(e,(async(e,a)=>{try{s.d(t,{AN:()=>j,B2:()=>E,BV:()=>z,DR:()=>V,E$:()=>M,GW:()=>T,KJ:()=>Z,Q4:()=>x,RB:()=>O,WN:()=>A,X4:()=>Q,_d:()=>L,al:()=>U,bs:()=>P,c:()=>$,gv:()=>F,m7:()=>b,oU:()=>S,tb:()=>K,uh:()=>C,yM:()=>H});s(89655),s(253),s(54846),s(16891);var i=s(31195),o=s(77301),n=s(91103),r=s(39902),l=s(72730),c=s(61310),h=s(31293),_=s(63165),d=s(60132),f=s(83324),u=s(84280),g=s(94100),m=s(78691),y=s(41924),p=s(10469),k=s(31265),v=s(4826),D=e([m,y]);[m,y]=D.then?(await D)():D;const w=[],b=()=>({stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),O=()=>({stat_energy_to:"",stat_compensation:null,entity_energy_price:null,number_energy_price:null}),C=()=>({type:"grid",flow_from:[],flow_to:[],cost_adjustment_day:0}),x=()=>({type:"solar",stat_energy_from:"",config_entry_solar_forecast:null}),S=()=>({type:"battery",stat_energy_from:"",stat_energy_to:""}),$=()=>({type:"gas",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),T=()=>({type:"water",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),z=e=>e.callWS({type:"energy/info"}),E=async e=>(await e.loadBackendTranslation("issues","energy"),e.callWS({type:"energy/validate"})),P=e=>e.callWS({type:"energy/get_prefs"}),A=async(e,t)=>{const s=e.callWS({type:"energy/save_prefs",...t});return R(e),s},W=async(e,t,s,a,i,o="hour")=>e.callWS({type:"energy/fossil_energy_consumption",start_time:t.toISOString(),end_time:i?.toISOString(),energy_statistic_ids:s,co2_statistic_id:a,period:o}),M=e=>(0,p.$)(e.energy_sources,(e=>e.type)),j=(e,t,s)=>{const a=[];for(const i of e.energy_sources)if(!s||s.includes(i.type))if("solar"!==i.type)if("gas"!==i.type&&"water"!==i.type)if("battery"!==i.type){for(const e of i.flow_from){a.push(e.stat_energy_from),e.stat_cost&&a.push(e.stat_cost);const s=t.cost_sensors[e.stat_energy_from];s&&a.push(s)}for(const e of i.flow_to){a.push(e.stat_energy_to),e.stat_compensation&&a.push(e.stat_compensation);const s=t.cost_sensors[e.stat_energy_to];s&&a.push(s)}}else a.push(i.stat_energy_from),a.push(i.stat_energy_to);else{a.push(i.stat_energy_from),i.stat_cost&&a.push(i.stat_cost);const e=t.cost_sensors[i.stat_energy_from];e&&a.push(e)}else a.push(i.stat_energy_from);return s&&!s.includes("device")||a.push(...e.device_consumption.map((e=>e.stat_consumption))),a},q=async(e,t,s,a,_)=>{const[d,f]=await Promise.all([(0,k.VN)(e,{domain:"co2signal"}),z(e)]),u=d.length?d[0]:void 0;let g;if(u)for(const t of Object.values(e.entities)){if("co2signal"!==t.platform)continue;const s=e.states[t.entity_id];if(s&&"%"===s.attributes.unit_of_measurement){g=s.entity_id;break}}const y=[];for(const e of t.energy_sources)if("grid"===e.type)for(const t of e.flow_from)y.push(t.stat_energy_from);const p=j(t,f,["grid","solar","battery","gas","device"]),D=j(t,f,["water"]),w=[...p,...D],b=(0,i.c)(a||new Date,s),O=b>35?"month":b>2?"day":"hour",C=e.config.unit_system.length||"",x={energy:"kWh",volume:"km"===C?"m³":"ft³"},S={volume:"km"===C?"L":"gal"},$=p.length?(0,v.sz)(e,s,a,p,O,x,["change"]):{},T=D.length?(0,v.sz)(e,s,a,D,O,S,["change"]):{};let E,P,A,M,q,R={},N={};_&&(P=(0,m.xo)(s,o.e,e.locale,e.config)&&(0,m.xo)(a||new Date,n.c,e.locale,e.config)?(0,m.ol)(s,r.P,e.locale,e.config,-(0,m.EO)(a||new Date,s,l.W,e.locale,e.config)-1):(0,m.ol)(s,c.f,e.locale,e.config,-1*(b+1)),A=(0,h.A)(s,-1),p.length&&(R=(0,v.sz)(e,P,A,p,O,x,["change"])),D.length&&(N=(0,v.sz)(e,P,A,D,O,S,["change"]))),void 0!==g&&(M=W(e,s,y,g,a,b>35?"month":b>2?"day":"hour"),_&&(q=W(e,P,y,g,A,b>35?"month":b>2?"day":"hour")));const K={},U=w.length?(0,v.Wr)(e,w):[],[B,L,Z,H,Q,F,I]=await Promise.all([$,T,R,N,U,M,q]),V={...B,...L};_&&(E={...Z,...H}),w.length&&Q.forEach((e=>{K[e.statistic_id]=e}));return{start:s,end:a,startCompare:P,endCompare:A,info:f,prefs:t,stats:V,statsMetadata:K,statsCompare:E,co2SignalConfigEntry:u,co2SignalEntity:g,fossilEnergyConsumption:F,fossilEnergyConsumptionCompare:I}},R=e=>{w.forEach((t=>{const s=K(e,{key:t});s.clearPrefs(),s._active&&s.refresh()}))},N=e=>{if(e._refreshTimeout&&clearTimeout(e._refreshTimeout),e._active&&(!e.end||e.end>new Date)){const t=new Date;t.getMinutes()>=20&&t.setHours(t.getHours()+1),t.setMinutes(20,0,0),e._refreshTimeout=window.setTimeout((()=>e.refresh()),t.getTime()-Date.now())}},K=(e,t={})=>{let s="_energy";if(t.key){if(!t.key.startsWith("energy_"))throw new Error("Key need to start with energy_");s=`_${t.key}`}if(e.connection[s])return e.connection[s];w.push(t.key);const a=(0,u.X)(e.connection,s,(async()=>(a.prefs||(a.prefs=await P(e)),N(a),q(e,a.prefs,a.start,a.end,a.compare)))),i=a.subscribe;a.subscribe=e=>{const t=i(e);return a._active++,void 0===a._refreshTimeout&&N(a),()=>{a._active--,a._active<1&&(clearTimeout(a._refreshTimeout),a._refreshTimeout=void 0),t()}},a._active=0,a.prefs=t.prefs;const o=new Date,n=(0,y.LW)(o,e.locale,e.config).split(":")[0];a.start=(0,m.ol)("0"===n?(0,c.f)(o,-1):o,_.o,e.locale,e.config),a.end=(0,m.ol)("0"===n?(0,c.f)(o,-1):o,d.D,e.locale,e.config);const r=()=>{a._updatePeriodTimeout=window.setTimeout((()=>{a.start=(0,m.ol)(new Date,_.o,e.locale,e.config),a.end=(0,m.ol)(new Date,d.D,e.locale,e.config),r()}),(0,f.L)((0,m.ol)(o,d.D,e.locale,e.config),1).getTime()-Date.now())};return r(),a.clearPrefs=()=>{a.prefs=void 0},a.setPeriod=(t,s)=>{a.start=t,a.end=s,a.start.getTime()!==(0,m.ol)(new Date,_.o,e.locale,e.config).getTime()||a.end?.getTime()!==(0,m.ol)(new Date,d.D,e.locale,e.config).getTime()||a._updatePeriodTimeout?a._updatePeriodTimeout&&(clearTimeout(a._updatePeriodTimeout),a._updatePeriodTimeout=void 0):r()},a.setCompare=e=>{a.compare=e},a},U=e=>e.callWS({type:"energy/solar_forecast"}),B=["volume","energy"],L=(e,t={},s)=>{for(const a of e.energy_sources){if("gas"!==a.type)continue;if(s&&s===a.stat_energy_from)continue;const e=t[a.stat_energy_from];if(B.includes(e?.unit_class))return e.unit_class}},Z=(e,t,s={})=>{const a=L(t,s);if(void 0!==a)return"energy"===a?"kWh":"km"===e.config.unit_system.length?"m³":"ft³"},H=e=>"km"===e.config.unit_system.length?"L":"gal",Q="/docs/energy/faq/#troubleshooting-missing-entities",F=(0,g.A)((e=>({summedData:I(e),compareSummedData:e.statsCompare?I(e,!0):void 0}))),I=(e,t)=>{const s={};for(const t of e.prefs.energy_sources)if("solar"!==t.type)if("battery"!==t.type){if("grid"===t.type){for(const e of t.flow_from)s.from_grid?s.from_grid.push(e.stat_energy_from):s.from_grid=[e.stat_energy_from];for(const e of t.flow_to)s.to_grid?s.to_grid.push(e.stat_energy_to):s.to_grid=[e.stat_energy_to]}}else s.to_battery?(s.to_battery.push(t.stat_energy_to),s.from_battery.push(t.stat_energy_from)):(s.to_battery=[t.stat_energy_to],s.from_battery=[t.stat_energy_from]);else s.solar?s.solar.push(t.stat_energy_from):s.solar=[t.stat_energy_from];const a={};return Object.entries(s).forEach((([s,i])=>{const o={},n={};i.forEach((s=>{const a=t?e.statsCompare[s]:e.stats[s];if(!a)return;a.forEach((e=>{if(null===e.change||void 0===e.change)return;const t=e.change;o[e.start]=e.start in o?o[e.start]+t:t})),n[s]={}})),a[s]=o})),a},V=(0,g.A)(((e,t)=>({consumption:X(e),compareConsumption:t?X(t):void 0}))),X=e=>{const t={total:{}};return Object.keys(e).forEach((s=>{Object.keys(e[s]).forEach((s=>{if(void 0===t.total[s]){const a=(e.from_grid?.[s]||0)+(e.solar?.[s]||0)+(e.from_battery?.[s]||0)-(e.to_grid?.[s]||0)-(e.to_battery?.[s]||0);t.total[s]=a}}))})),t};a()}catch(e){a(e)}}))},12477:(e,t,s)=>{s.a(e,(async(e,t)=>{try{var a=s(36312),i=s(68689),o=(s(72606),s(63165)),n=s(60132),r=s(30745),l=s(24085),c=s(82278),h=s(33645),_=s(12152),d=s(72519),f=s(93094),u=s(8142),g=s(84865),m=s(31195),y=s(77301),p=s(91103),k=s(72730),v=s(39902),D=s(61310),w=s(75697),b=s(50289),O=s(29818),C=s(94100),x=s(78691),S=s(65544),$=s(57289),T=s(18409),z=(s(26790),s(35619),s(9043)),E=(s(63606),s(40462),s(47076)),P=s(20712),A=e([x,$,z,E]);[x,$,z,E]=A.then?(await A)():A;const W="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z";(0,a.A)([(0,O.EM)("hui-energy-period-selector")],(function(e,t){class s extends t{constructor(...t){super(...t),e(this)}}return{F:s,d:[{kind:"field",decorators:[(0,O.MZ)({attribute:!1})],key:"hass",value:void 0},{kind:"field",decorators:[(0,O.MZ)()],key:"collectionKey",value:void 0},{kind:"field",decorators:[(0,O.MZ)({type:Boolean,reflect:!0})],key:"narrow",value:void 0},{kind:"field",decorators:[(0,O.wk)()],key:"_startDate",value:void 0},{kind:"field",decorators:[(0,O.wk)()],key:"_endDate",value:void 0},{kind:"field",decorators:[(0,O.wk)()],key:"_ranges",value:()=>({})},{kind:"field",decorators:[(0,O.wk)()],key:"_compare",value:()=>!1},{kind:"field",key:"_resizeObserver",value:void 0},{kind:"method",key:"hassSubscribe",value:function(){return[(0,E.tb)(this.hass,{key:this.collectionKey}).subscribe((e=>this._updateDates(e)))]}},{kind:"method",key:"_measure",value:function(){this.narrow=this.offsetWidth<450}},{kind:"method",key:"_attachObserver",value:async function(){this._resizeObserver||(this._resizeObserver=new ResizeObserver((0,T.s)((()=>this._measure()),250,!1))),this._resizeObserver.observe(this)}},{kind:"method",key:"firstUpdated",value:function(){this._attachObserver()}},{kind:"method",key:"connectedCallback",value:function(){(0,i.A)(s,"connectedCallback",this,3)([]),this.updateComplete.then((()=>this._attachObserver()))}},{kind:"method",key:"disconnectedCallback",value:function(){(0,i.A)(s,"disconnectedCallback",this,3)([]),this._resizeObserver&&this._resizeObserver.disconnect()}},{kind:"method",key:"willUpdate",value:function(e){if((0,i.A)(s,"willUpdate",this,3)([e]),this.hasUpdated||this._measure(),!this.hasUpdated||e.has("hass")&&this.hass?.localize!==e.get("hass")?.localize){const e=new Date,t=(0,S.PE)(this.hass.locale);this._ranges={[this.hass.localize("ui.components.date-range-picker.ranges.today")]:[(0,x.ol)(e,o.o,this.hass.locale,this.hass.config,{weekStartsOn:t}),(0,x.ol)(e,n.D,this.hass.locale,this.hass.config,{weekStartsOn:t})],[this.hass.localize("ui.components.date-range-picker.ranges.yesterday")]:[(0,x.ol)((0,x.ol)(e,r.e,this.hass.locale,this.hass.config,1),o.o,this.hass.locale,this.hass.config,{weekStartsOn:t}),(0,x.ol)((0,x.ol)(e,r.e,this.hass.locale,this.hass.config,1),n.D,this.hass.locale,this.hass.config,{weekStartsOn:t})],[this.hass.localize("ui.components.date-range-picker.ranges.this_week")]:[(0,x.ol)(e,l.k,this.hass.locale,this.hass.config,{weekStartsOn:t}),(0,x.ol)(e,c.$,this.hass.locale,this.hass.config,{weekStartsOn:t})],[this.hass.localize("ui.components.date-range-picker.ranges.this_month")]:[(0,x.ol)(e,h.w,this.hass.locale,this.hass.config),(0,x.ol)(e,_.p,this.hass.locale,this.hass.config)],[this.hass.localize("ui.components.date-range-picker.ranges.this_quarter")]:[(0,x.ol)(e,d.a,this.hass.locale,this.hass.config),(0,x.ol)(e,f.j,this.hass.locale,this.hass.config)],[this.hass.localize("ui.components.date-range-picker.ranges.this_year")]:[(0,x.ol)(e,u.D,this.hass.locale,this.hass.config),(0,x.ol)(e,g.Q,this.hass.locale,this.hass.config)]}}}},{kind:"method",key:"render",value:function(){if(!this.hass||!this._startDate)return b.s6;const e=this._simpleRange(this._startDate,this._endDate,this.hass.locale,this.hass.config);return b.qy` <div class="row"> <div class="label"> ${"day"===e?this.narrow?(0,$.kz)(this._startDate,this.hass.locale,this.hass.config):(0,$.Yq)(this._startDate,this.hass.locale,this.hass.config):"month"===e?(0,$.fr)(this._startDate,this.hass.locale,this.hass.config):"year"===e?(0,$.Pm)(this._startDate,this.hass.locale,this.hass.config):`${(0,$.sl)(this._startDate,this.hass.locale,this.hass.config)} – ${(0,$.sl)(this._endDate||new Date,this.hass.locale,this.hass.config)}`} </div> <div class="time-handle"> <ha-icon-button-prev .label="${this.hass.localize("ui.panel.lovelace.components.energy_period_selector.previous")}" @click="${this._pickPrevious}"></ha-icon-button-prev> <ha-icon-button-next .label="${this.hass.localize("ui.panel.lovelace.components.energy_period_selector.next")}" @click="${this._pickNext}"></ha-icon-button-next> <ha-date-range-picker .hass="${this.hass}" .startDate="${this._startDate}" .endDate="${this._endDate||new Date}" .ranges="${this._ranges}" @change="${this._dateRangeChanged}" .timePicker="${!1}" minimal></ha-date-range-picker> </div> ${this.narrow?b.s6:b.qy`<mwc-button dense outlined @click="${this._pickNow}"> ${this.hass.localize("ui.panel.lovelace.components.energy_period_selector.now")} </mwc-button>`} <ha-button-menu> <ha-icon-button slot="trigger" .label="${this.hass.localize("ui.common.menu")}" .path="${W}"></ha-icon-button> <ha-check-list-item left @request-selected="${this._toggleCompare}" .selected="${this._compare}"> ${this.hass.localize("ui.panel.lovelace.components.energy_period_selector.compare")} </ha-check-list-item> <slot name="overflow-menu"></slot> </ha-button-menu> </div> `}},{kind:"field",key:"_simpleRange",value:()=>(0,C.A)(((e,t,s,a)=>{if(0===(0,m.c)(t,e))return"day";if((0,x.xo)(e,y.e,s,a)&&(0,x.xo)(t,p.c,s,a)){if(0===(0,x.EO)(t,e,k.W,s,a))return"month";if(2===(0,x.EO)(t,e,k.W,s,a)&&e.getMonth()%3==0)return"quarter"}return(0,x.xo)(e,y.e,s,a)&&(0,x.xo)(t,p.c,s,a)&&11===(0,x.EO)(t,e,k.W,s,a)?"year":"other"}))},{kind:"method",key:"_updateCollectionPeriod",value:function(){const e=(0,E.tb)(this.hass,{key:this.collectionKey});e.setPeriod(this._startDate,this._endDate),e.refresh()}},{kind:"method",key:"_dateRangeChanged",value:function(e){const t=(0,S.PE)(this.hass.locale);this._startDate=(0,x.ol)(e.detail.startDate,o.o,this.hass.locale,this.hass.config,{weekStartsOn:t}),this._endDate=(0,x.ol)(e.detail.endDate,n.D,this.hass.locale,this.hass.config,{weekStartsOn:t}),this._updateCollectionPeriod()}},{kind:"method",key:"_pickNow",value:function(){if(!this._startDate)return;const e=this._simpleRange(this._startDate,this._endDate,this.hass.locale,this.hass.config),t=new Date;if("month"===e)this._startDate=(0,x.ol)(t,h.w,this.hass.locale,this.hass.config),this._endDate=(0,x.ol)(t,_.p,this.hass.locale,this.hass.config);else if("quarter"===e)this._startDate=(0,x.ol)(t,d.a,this.hass.locale,this.hass.config),this._endDate=(0,x.ol)(t,f.j,this.hass.locale,this.hass.config);else if("year"===e)this._startDate=(0,x.ol)(t,u.D,this.hass.locale,this.hass.config),this._endDate=(0,x.ol)(t,g.Q,this.hass.locale,this.hass.config);else{const e=(0,S.PE)(this.hass.locale),s=(0,x.ol)(this._endDate,l.k,this.hass.locale,this.hass.config,{weekStartsOn:e}),a=(0,x.ol)(this._endDate,c.$,this.hass.locale,this.hass.config,{weekStartsOn:e});if(this._startDate.getTime()===s.getTime()&&this._endDate.getTime()===a.getTime())this._startDate=(0,x.ol)(t,l.k,this.hass.locale,this.hass.config,{weekStartsOn:e}),this._endDate=(0,x.ol)(t,c.$,this.hass.locale,this.hass.config,{weekStartsOn:e});else{const s=(0,x.EO)(this._endDate,this._startDate,m.c,this.hass.locale,this.hass.config);this._startDate=(0,x.ol)((0,x.ol)(t,r.e,this.hass.locale,this.hass.config,s),o.o,this.hass.locale,this.hass.config,{weekStartsOn:e}),this._endDate=(0,x.ol)(t,n.D,this.hass.locale,this.hass.config,{weekStartsOn:e})}}this._updateCollectionPeriod()}},{kind:"method",key:"_pickPrevious",value:function(){this._shift(!1)}},{kind:"method",key:"_pickNext",value:function(){this._shift(!0)}},{kind:"method",key:"_shift",value:function(e){if(!this._startDate)return;let t,s;if((0,x.xo)(this._startDate,y.e,this.hass.locale,this.hass.config)&&(0,x.xo)(this._endDate,p.c,this.hass.locale,this.hass.config)){const a=((0,x.EO)(this._endDate,this._startDate,k.W,this.hass.locale,this.hass.config)+1)*(e?1:-1);t=(0,x.ol)(this._startDate,v.P,this.hass.locale,this.hass.config,a),s=(0,x.ol)((0,x.ol)(this._endDate,v.P,this.hass.locale,this.hass.config,a),_.p,this.hass.locale,this.hass.config)}else{const a=((0,x.EO)(this._endDate,this._startDate,m.c,this.hass.locale,this.hass.config)+1)*(e?1:-1);t=(0,x.ol)(this._startDate,D.f,this.hass.locale,this.hass.config,a),s=(0,x.ol)(this._endDate,D.f,this.hass.locale,this.hass.config,a)}this._startDate=t,this._endDate=s,this._updateCollectionPeriod()}},{kind:"method",key:"_updateDates",value:function(e){this._compare=void 0!==e.startCompare,this._startDate=e.start,this._endDate=e.end||(0,w.o)()}},{kind:"method",key:"_toggleCompare",value:function(e){if("interaction"!==e.detail.source)return;this._compare=e.detail.selected;const t=(0,E.tb)(this.hass,{key:this.collectionKey});t.setCompare(this._compare),t.refresh()}},{kind:"get",static:!0,key:"styles",value:function(){return b.AH`.row{display:flex;align-items:center}:host .time-handle{display:flex;justify-content:flex-end;align-items:center}:host([narrow]) .time-handle{margin-left:auto;margin-inline-start:auto;margin-inline-end:initial}.label{display:flex;align-items:center;justify-content:flex-end;font-size:20px;margin-left:auto;margin-inline-start:auto;margin-inline-end:initial}:host([narrow]) .label{margin-left:unset;margin-inline-start:unset;margin-inline-end:initial}mwc-button{margin-left:8px;margin-inline-start:8px;margin-inline-end:initial;flex-shrink:0;--mdc-button-outline-color:currentColor;--primary-color:currentColor;--mdc-theme-primary:currentColor;--mdc-theme-on-primary:currentColor;--mdc-button-disabled-outline-color:var(--disabled-text-color);--mdc-button-disabled-ink-color:var(--disabled-text-color)}`}}]}}),(0,P.E)(b.WF));t()}catch(e){t(e)}}))}};
//# sourceMappingURL=12477.llCCxlGUle4.js.map